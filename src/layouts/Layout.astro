---
import "../styles/global.css";

type Props = {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
};

const {
  title = "Smarttec | Reparaci贸n de iPhone y Smartphones en Le贸n, Gto.",
  description = "Especialistas en reparaci贸n de iPhone, Samsung y Huawei en Le贸n. Pantallas, bater铆as y tarjeta madre con garant铆a. 隆Servicio express en Blvd. Campestre!",
  canonical,
  ogImage,
} = Astro.props;

const site = "https://smarttec.mx"; // Reemplaza con  dominio final
const canonicalUrl = canonical || new URL(Astro.url.pathname, site).toString();
const ogImageUrl = ogImage || `${site}/og-image.jpg`;

const phoneE164 = "+524792155743";
const lat = 21.1526109;
const lng = -101.695822;

const schema = {
  "@context": "https://schema.org",
  "@type": ["LocalBusiness", "RepairService"],
  name: "Smarttec - Reparaci贸n de celulares y iPhone",
  image: ogImageUrl,
  "@id": site,
  url: site,
  telephone: phoneE164,
  priceRange: "$$",
  address: {
    "@type": "PostalAddress",
    streetAddress: "Blvd. Campestre 923, Valle del Campestre",
    addressLocality: "Le贸n",
    addressRegion: "Guanajuato",
    postalCode: "37160",
    addressCountry: "MX",
  },
  geo: {
    "@type": "GeoCoordinates",
    latitude: lat,
    longitude: lng,
  },
  openingHoursSpecification: [
    {
      "@type": "OpeningHoursSpecification",
      dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
      opens: "10:00",
      closes: "19:00",
    },
    {
      "@type": "OpeningHoursSpecification",
      dayOfWeek: "Saturday",
      opens: "10:00",
      closes: "14:00",
    },
  ],
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: "5.0",
    reviewCount: "24", // Ajusta seg煤n tus rese帽as actuales
  },
};
---

<!doctype html>
<html lang="es-MX">
  <head>
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        const wAny = w as any;
        wAny[l] = wAny[l] || [];
        wAny[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0] as Element | null,
          j = d.createElement(s) as HTMLScriptElement,
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        if (f && f.parentNode) {
          f.parentNode.insertBefore(j, f);
        } else {
          d.head?.appendChild(j);
        }
      })(window, document, "script", "dataLayer", "GTM-T79WX4N5");
    </script>
    <!-- End Google Tag Manager -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>{title}</title>
    <meta name="description" content={description} />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />

    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

    <meta name="robots" content="index,follow,max-image-preview:large" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />

    <link rel="alternate" hreflang="es-MX" href={canonicalUrl ?? site ?? "/"} />

    <!--  MEJORADO: Open Graph con imagen -->
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_MX" />
    <meta property="og:site_name" content="Smarttec" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta
      property="og:image:alt"
      content="Smarttec - Reparaci贸n premium de iPhone en Le贸n"
    />

    <!--  MEJORADO: Twitter Card con imagen -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta
      name="twitter:image:alt"
      content="Smarttec - Reparaci贸n premium de iPhone en Le贸n"
    />

    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      content="#f4f2ee"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#0b0f14"
      media="(prefers-color-scheme: dark)"
    />

    <link rel="preconnect" href="https://www.google.com" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />

    <!-- JSON-LD con todo incluido -->
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />

    <script is:inline>
      (() => {
        const key = "smarttec-theme";
        const root = document.documentElement;

        const saved = localStorage.getItem(key);
        const hasOverride = saved === "dark" || saved === "light";

        const apply = (mode) => {
          if (mode === "dark") root.classList.add("dark");
          else root.classList.remove("dark");
        };

        const mq = window.matchMedia
          ? window.matchMedia("(prefers-color-scheme: dark)")
          : null;
        const prefersDark = mq ? mq.matches : false;

        apply(hasOverride ? saved : prefersDark ? "dark" : "light");

        if (!hasOverride && mq) {
          const onChange = (e) => apply(e.matches ? "dark" : "light");
          if (mq.addEventListener) mq.addEventListener("change", onChange);
          else mq.addListener?.(onChange);
        }
      })();
    </script>
  </head>

  <body class="min-h-dvh antialiased">
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T79WX4N5"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe></noscript
    >
    <!-- End Google Tag Manager (noscript) -->
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-[9999] focus:rounded-xl focus:bg-[color:var(--color-bg)] focus:px-4 focus:py-3 focus:text-sm focus:font-semibold focus:text-[color:var(--color-ink)] focus:shadow-lg"
    >
      Saltar al contenido
    </a>

    <slot />

    <script is:inline>
      (() => {
        const key = "smarttec-theme";

        const syncThemeIcon = () => {
          const btn = document.getElementById("themeToggle");
          if (!btn) return;

          const moon = btn.querySelector('[data-theme-icon="moon"]');
          const sun = btn.querySelector('[data-theme-icon="sun"]');
          if (!(moon instanceof Element) || !(sun instanceof Element)) return;

          const root = document.documentElement;
          const isDark = root.classList.contains("dark");

          if (isDark) {
            sun.classList.remove("hidden");
            moon.classList.add("hidden");
          } else {
            moon.classList.remove("hidden");
            sun.classList.add("hidden");
          }
        };

        const handleToggle = () => {
          const root = document.documentElement;
          const isDark = !root.classList.contains("dark");

          // Si el browser soporta View Transitions API
          if (document.startViewTransition) {
            document.startViewTransition(() => {
              root.classList.toggle("dark");
              localStorage.setItem(key, isDark ? "dark" : "light");
              syncThemeIcon();
            });
          } else {
            // Fallback instant谩neo
            root.classList.toggle("dark");
            localStorage.setItem(key, isDark ? "dark" : "light");
            syncThemeIcon();
          }
        };

        document.addEventListener("click", (e) => {
          const target = e.target;
          if (!(target instanceof Element)) return;

          const btn = target.closest("#themeToggle");
          if (!btn) return;

          handleToggle();
        });
      })();
    </script>
  </body>
</html>
