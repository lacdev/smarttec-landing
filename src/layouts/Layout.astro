---
import "../styles/global.css";

type Props = {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string; //  NUEVO: permite pasar imagen custom
};

const {
  title = "Smarttec | Reparaci贸n premium de iPhone en Le贸n, Gto.",
  description = "Reparaci贸n premium de iPhone y smartphones en Le贸n, Gto. +15 a帽os de experiencia. Express en bater铆a/centro de carga (seg煤n modelo), pantallas, mojados y placa. 90 d铆as de garant铆a por escrito.",
  canonical,
  ogImage,
} = Astro.props;

const site = Astro.site ? Astro.site.toString() : undefined;
const canonicalUrl = canonical
  ? canonical
  : site
    ? new URL(Astro.url.pathname, site).toString()
    : undefined;

// OG Image URL - SIMPLIFICADO
const siteOrigin = site
  ? new URL(site).origin
  : "https://smarttec-landing.vercel.app";
const ogImageUrl = ogImage || `${siteOrigin}/og-image.jpg`;

const phoneE164 = "+524792155743";
const mapsUrl = "https://maps.app.goo.gl/bYxzHKAHKJj3JeAZ6";
const reviewUrl = "https://g.page/r/CTx7L5uuenBrEBM/review";

//  MEJORA: Schema con aggregateRating si tienes las rese帽as
const schema = {
  "@context": "https://schema.org",
  "@type": ["LocalBusiness", "RepairService"],
  ...(canonicalUrl ? { "@id": `${canonicalUrl}#smarttec` } : {}),
  name: "Smarttec",
  telephone: phoneE164,
  url: canonicalUrl ?? site,
  ...(ogImageUrl ? { image: ogImageUrl } : {}), //  NUEVO
  description: description, //  NUEVO
  address: {
    "@type": "PostalAddress",
    streetAddress: "Av. Panorama 923, esquina con Blvd. Campestre",
    addressLocality: "Le贸n",
    addressRegion: "Guanajuato",
    addressCountry: "MX",
  },
  areaServed: { "@type": "City", name: "Le贸n, Guanajuato" },
  openingHoursSpecification: [
    {
      "@type": "OpeningHoursSpecification",
      dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
      opens: "10:00",
      closes: "19:00",
    },
    {
      "@type": "OpeningHoursSpecification",
      dayOfWeek: ["Saturday"],
      opens: "10:00",
      closes: "14:00",
    },
  ],
  priceRange: "$$",
  hasMap: mapsUrl,
  sameAs: [mapsUrl, reviewUrl],
  knowsAbout: [
    "Reparaci贸n de iPhone",
    "Reparaci贸n de smartphones",
    "Cambio de bater铆a",
    "Cambio de pantalla",
    "Centro de carga",
    "Microsoldadura",
    "Da帽o por l铆quido",
  ],
  //  NUEVO: Solo si tienes rese帽as reales verificables
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: "5",
    reviewCount: "8",
    bestRating: "5",
    worstRating: "5",
  },
};
---

<!doctype html>
<html lang="es-MX">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <title>{title}</title>
    <meta name="description" content={description} />

    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

    <meta name="robots" content="index,follow,max-image-preview:large" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />

    <link rel="alternate" hreflang="es-MX" href={canonicalUrl ?? site ?? "/"} />

    <!--  MEJORADO: Open Graph con imagen -->
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="es_MX" />
    <meta property="og:site_name" content="Smarttec" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta
      property="og:image:alt"
      content="Smarttec - Reparaci贸n premium de iPhone en Le贸n"
    />

    <!--  MEJORADO: Twitter Card con imagen -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta
      name="twitter:image:alt"
      content="Smarttec - Reparaci贸n premium de iPhone en Le贸n"
    />

    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      content="#f4f2ee"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#0b0f14"
      media="(prefers-color-scheme: dark)"
    />

    <link rel="preconnect" href="https://www.google.com" />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />

    <!-- JSON-LD con todo incluido -->
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />

    <script is:inline>
      (() => {
        const key = "smarttec-theme";
        const root = document.documentElement;

        const saved = localStorage.getItem(key);
        const hasOverride = saved === "dark" || saved === "light";

        const apply = (mode) => {
          if (mode === "dark") root.classList.add("dark");
          else root.classList.remove("dark");
        };

        const mq = window.matchMedia
          ? window.matchMedia("(prefers-color-scheme: dark)")
          : null;
        const prefersDark = mq ? mq.matches : false;

        apply(hasOverride ? saved : prefersDark ? "dark" : "light");

        if (!hasOverride && mq) {
          const onChange = (e) => apply(e.matches ? "dark" : "light");
          if (mq.addEventListener) mq.addEventListener("change", onChange);
          else mq.addListener?.(onChange);
        }
      })();
    </script>
  </head>

  <body class="min-h-dvh antialiased">
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-[9999] focus:rounded-xl focus:bg-[color:var(--color-bg)] focus:px-4 focus:py-3 focus:text-sm focus:font-semibold focus:text-[color:var(--color-ink)] focus:shadow-lg"
    >
      Saltar al contenido
    </a>

    <slot />

    <script is:inline>
      (() => {
        const key = "smarttec-theme";

        const syncThemeIcon = () => {
          const btn = document.getElementById("themeToggle");
          if (!btn) return;

          const moon = btn.querySelector('[data-theme-icon="moon"]');
          const sun = btn.querySelector('[data-theme-icon="sun"]');
          if (!(moon instanceof Element) || !(sun instanceof Element)) return;

          const root = document.documentElement;
          const isDark = root.classList.contains("dark");

          if (isDark) {
            sun.classList.remove("hidden");
            moon.classList.add("hidden");
          } else {
            moon.classList.remove("hidden");
            sun.classList.add("hidden");
          }
        };

        const handleToggle = () => {
          const root = document.documentElement;

          root.classList.add("theme-transition");

          const isDark = root.classList.toggle("dark");
          localStorage.setItem(key, isDark ? "dark" : "light");

          syncThemeIcon();

          window.setTimeout(
            () => root.classList.remove("theme-transition"),
            220,
          );
        };

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", syncThemeIcon);
        } else {
          syncThemeIcon();
        }

        document.addEventListener("click", (e) => {
          const target = e.target;
          if (!(target instanceof Element)) return;

          const btn = target.closest("#themeToggle");
          if (!btn) return;

          handleToggle();
        });
      })();
    </script>
  </body>
</html>
